---
title: "Housing Price vs. Supply 2024"
author: Stephanie Armstrong, Ilgaz Kuscu, Alexander D. Silberman, Baylee Wechsler
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r}
rm(list=ls())
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      root.dir = "C:\\Users\\alexa\\Code\\GW DATS\\6101 Intro to Data Science\\Project 1\\GitHub",
                      warning = F, message = F)
options(scientific = T, digits = 3)
```


## Load requisite packages and data


```{r libraries}
library(ezids)
library(ggplot2)
library(dplyr)
library(readr)
library(tidyverse)
library (tidyr)
library(janitor)
library(scales)
library(ggrepel)
library(corrplot)
library(tigris)
library(sf)
```

This project uses the State and County Housing Market Indicators dataset from the American Enterprise Institute Housing Center, found [here](https://www.aei.org/the-state-of-the-housing-market/). The variables are:  

Original Variable Name | New Variable Name | Definition  
  :-: |  :-: | :-- 
State	| State |state
County | County_Name |County
FIPS | FIPS_County_Code | 5-digit Federal Information Processing Series codes (first 2 digits indicate state, last 3 indicate sub-county entity)
Year | Year | Year when the data was collected
Tier | Affordability | Categorizes home sales into entry-level (<=80th percentile of FHA sales prices), move-up (all others), and all
Median.Sale.Price..in.Thousands. | Median_Sale_Price_in_k | Median sale price in thousands of USD per county
House.Price.Appreciation.since.2012 | House_Price_Appreciation_since_2012_percent | Cumulative home price appreciation since 2012
House.Price.Appreciation..Year.over.Year | House_Price_Appreciation_yr_over_yr_percent |Home price appreciation since the previous year
Months..Supply | Months_Supply | Number of months it would take for the inventory of existing homes for sale to be exhausted at the current sales pace
New.Construction.Share.of.Sales | New_Constr_by_share_of_sales_percent | Percent of sales comprising new construction
Mortgage.Default.Rate | Mortgage_Default_Rate_percent | AEI Mortgage Default Rate, a measure of how loans originating in a given month would perform under the same conditions as the 2007 financial crisis (<=7%: Low Risk; between 7.01% and 14%: Medium Risk; >14%: High Risk)


```{r read_data}
housing = read.csv("..//Data//state_county_data_download_2025.csv")
housing %>% slice_sample(n=5)
```


The data is limited to the year 2024 and cleaned of NA values, and the variables are renamed for clarity.


```{r clean_data}
housing_2024 = housing %>% filter(housing$Year == 2024, 
                                  housing$State != 'AA National', 
                                  housing$County != 'AA State') %>%
  #moving this na removal to the end after the cleaning
  na.omit %>% 
  #excluding the armed forces


#rename cols
rename(
  Median_Sale_Price_per_k = Median.Sale.Price..in.Thousands.,
  House_Price_Appreciation_yr_over_yr_percent = House.Price.Appreciation..Year.over.Year.,
  House_Price_Appreciation_since_2012_percent = House.Price.Appreciation.since.2012,
  Months_Supply = Months..Supply,
  New_Constr_by_share_of_sales_percent = New.Construction.Share.of.Sales,
  Mortgage_Default_Rate_percent = Mortgage.Default.Rate,
  County_Name = County,
  FIPS_County_Code = FIPS, 
  Affordability = Tier
)
head(housing_2024)
```


The typing of the variables is also corrected. Some require the symbols "$" and "%" to be removed beforehand, so that is also done.


```{r correct_var_typing}
# as factors
housing_2024$State = as.factor(housing_2024$State)
housing_2024$County_Name = as.factor(housing_2024$County_Name)
housing_2024$FIPS_County_Code = as.factor(housing_2024$FIPS_County_Code)
housing_2024$Affordability = as.factor(housing_2024$Affordability)

# remove prefixes '$' and '%' from values
housing_2024 = housing_2024 %>%
  mutate(Median_Sale_Price_per_k = gsub("[\\$,]", "", Median_Sale_Price_per_k),
         House_Price_Appreciation_since_2012_percent =
           gsub("[%,]","",House_Price_Appreciation_since_2012_percent),
         House_Price_Appreciation_yr_over_yr_percent =
           gsub("[%,]","",House_Price_Appreciation_yr_over_yr_percent),
         New_Constr_by_share_of_sales_percent = gsub("[%,]","",New_Constr_by_share_of_sales_percent),
         Mortgage_Default_Rate_percent = gsub("[%,]","",Mortgage_Default_Rate_percent)
  )
###I included the commas to be removed as well indicated in the brackets. SA

# as num instead of chr
housing_2024$Median_Sale_Price_per_k = as.numeric(housing_2024$Median_Sale_Price_per_k)
housing_2024$House_Price_Appreciation_since_2012_percent =
  as.numeric(housing_2024$House_Price_Appreciation_since_2012_percent)
housing_2024$House_Price_Appreciation_yr_over_yr_percent =
  as.numeric(housing_2024$House_Price_Appreciation_yr_over_yr_percent)
housing_2024$New_Constr_by_share_of_sales_percent = 
  as.numeric(housing_2024$New_Constr_by_share_of_sales_percent)
housing_2024$Mortgage_Default_Rate_percent = as.numeric(housing_2024$Mortgage_Default_Rate_percent)
###I included the commas to be removed as well indicated in the brackets. SA

#moving the na dropping to after the parsing
housing_2024 <- housing_2024 %>%
  tidyr::drop_na(Median_Sale_Price_per_k)

# For some reason is rounding the data in quite a weird wayâ€”inaccurately

# view data
housing_2024 %>% slice_sample(n=5)
```


```{r}
#creating df w/ affordability all totals and then another with entry level/moving up totals
housing_2024_all = housing_2024 %>% filter(housing_2024$Affordability == "all") 
housing_2024_tiers = housing_2024 %>% filter(Affordability == "entrylevel" | Affordability == "moveup")
#BW- we need to explain why we did this (not in the comments, in the write-up and presentation). Steph?
```


## Exploratory Data Analysis (EDA)


```{r}
xkablesummary(housing_2024)
```


```{r}
#separated df's
xkablesummary(housing_2024_all)
xkablesummary(housing_2024_tiers)

#comparing tiers entrylevel and 
#entrylevel
xkablesummary(df = subset(housing_2024_tiers, 
                          Affordability == "entrylevel"),
              title = "Summary Statistics: Entry-Level Homes",
              digits = 2,
              pos = "left",
              bso = "striped")

#moveup
xkablesummary(df = subset(housing_2024_tiers, 
                          Affordability == "moveup"),
              title = "Summary Statistics: Move-Up Homes",
              digits = 2,
              pos = "left",
              bso = "striped"
)
```


### boxplot of median sale price by state

```{r}
#boxplotting med sale price by state w/ ..._all df
#all
ggplot(housing_2024_all, aes(x = reorder(State, -Median_Sale_Price_per_k, median), 
                         y = Median_Sale_Price_per_k)) +
  geom_boxplot(fill = "steelblue", alpha = 0.7) +
  coord_flip() +
  labs(
    title = "Distribution of Median Sale Prices by State (2024)",
    x = "State",
    y = "Median Sale Price (in thousands)",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()
```

There are too many to be particularly useful. You can see general trends, but I am going to run this with a smaller state sample.

### boxplot of top and bottom 5 states by housing count
The states broken out by housing count extremes are:  

####Top Months Supply States  
HI | Hawaii
DC | District of Columbia 
FL | Florida
MT | Montana
CO | Colorado 
 
####Bottom Months Supply States	
MA| Massachusetts
WI | Wisconsin
KY | Kentucky
NH | New Hampshire
IN | Indiana
ND | North Dakota
OH | Ohio


```{r}
#boxplotting with new df: ..._all
#Find top/bottom 5 by *mean Months Supply*, not row count
states_by_mean_months_supply <- housing_2024_all %>%
  group_by(State) %>%
  summarize(Mean_Months_Supply = mean(Months_Supply))

top_states_all = states_by_mean_months_supply %>% slice_max(order_by = Mean_Months_Supply, n = 5)

bottom_states_all <- states_by_mean_months_supply %>% slice_min(order_by = Mean_Months_Supply, n = 5)

#merge top and bottom states
housing_compare_all <- housing_2024_all %>%
  filter(State %in% c(top_states_all$State, bottom_states_all$State)) %>%
  mutate(StateGroup = case_when(
    State %in% top_states_all$State ~ "High Months Supply",
    State %in% bottom_states_all$State ~ "Low Months Supply")) %>%
  mutate(StateGroup = factor(StateGroup, levels = c("Low Months Supply", "High Months Supply")))

#plot top bottom comparison ####
ggplot(housing_compare_all, aes(x = State, y = Median_Sale_Price_per_k, fill = StateGroup)) +
  geom_boxplot() +
  facet_wrap(~ StateGroup, scales = "free_x") +
  labs(
    title = "Mean Sale Price in States by Months Supply of Housing",
    subtitle = "The Mean Sale Price in States with a Larger Months Supply of Housing is Significantly Lower\nthan States with a Smaller Months Supply of Housing",
    x = "State",
    y = "Mean Sale Price (in thousands)",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal() +
  scale_fill_manual(values = c("High Months Supply" = "skyblue", "Low Months Supply" = "red"))
```

#### Significance Testing

```{r}
#states_mean_sale_price_anova = aov(data = housing_compare_all)
```


```{r}
# compare color scale w/ ..._all df
#fix color assigning for side by side compare scatterplots- too many blue showing up
#cleaned plot version with dropped unused (non-10) state levels; re-group by state for clarity
housing_compare_all_plot <- housing_compare_all %>%
  group_by(State, StateGroup) %>%
  summarize(
    Median_Sale_Price_per_k = median(Median_Sale_Price_per_k, na.rm = TRUE),
    Months_Supply = median(Months_Supply, na.rm = TRUE),
    .groups = "drop") %>%
  mutate(State = forcats::fct_drop(State))

#also fixing subset of housing 2024 all so that gray background dots are 1/state
housing_2024_all_plot <- housing_2024_all %>%
  group_by(State) %>%
  summarize(
    Median_Sale_Price_per_k = median(Median_Sale_Price_per_k, na.rm = TRUE),
    Months_Supply = median(Months_Supply, na.rm = TRUE),
    .groups = "drop")

#label points for 10 states 
label_points_all <- housing_compare_all_plot

#usig cleaned version of plot data to assign colors
top_states_colors_all <- scales::seq_gradient_pal("lightblue", "darkslateblue")(seq(0, 1, length.out = length(unique(housing_compare_all_plot$State[housing_compare_all_plot$StateGroup == "High Months Supply"]))))
names(top_states_colors_all) <- unique(housing_compare_all_plot$State[housing_compare_all_plot$StateGroup == "High Months Supply"])

bottom_states_colors_all <- scales::seq_gradient_pal("lightpink", "darkred")(seq(0, 1, length.out = length(unique(housing_compare_all_plot$State[housing_compare_all_plot$StateGroup == "Low Months Supply"]))))
names(bottom_states_colors_all) <- unique(housing_compare_all_plot$State[housing_compare_all_plot$StateGroup == "Low Months Supply"])

state_colors_all <- c(top_states_colors_all, bottom_states_colors_all)

#all in gray with faceted compare in color with states labeled ####
ggplot() +
  geom_point(data = housing_2024_all_plot, aes(x = Months_Supply, y = Median_Sale_Price_per_k),
             color = "gray70", alpha = 0.3, size = 1.5) +
  geom_point(data = housing_compare_all_plot,
             aes(x = Months_Supply, y = Median_Sale_Price_per_k, color = State),
             size = 1.5, alpha = 0.9) +
  geom_text_repel(data = label_points_all,
                  aes(x = Months_Supply, y = Median_Sale_Price_per_k, 
                      label = State),
                  size = 3.5, color= "black", stroke=0.01, segment.color = NA, segment.size = 0.3,
                  segment.alpha = 1, min.segment.length = 0, show.legend = FALSE) +
  facet_wrap(~ StateGroup) +
  scale_color_manual(values = state_colors_all) +
  labs(
    title = "Months Supply vs Median Price by State",
    subtitle = "The association between Low Months Supply and High Median Sale Price is Immediately Visible, While the",
    x = "Months of Supply",
    y = "Median Sale Price (in thousands)",
    color = "State",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()
```


```{r}
#boxplotting med sale price by state w/ ..._compare_all df
#all
ggplot(housing_compare_all, aes(x = reorder(State, -Median_Sale_Price_per_k, median), 
                         y = Median_Sale_Price_per_k)) +
  geom_boxplot(fill = state_colors_all, alpha = 0.7) +
  coord_flip() +
  labs(
    title = "Distribution of Median Sale Prices by State (2024)",
    x = "State",
    y = "Median Sale Price (in thousands)",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()
```



### hist of median sale price

```{r}
#hist plotting with df ..._all
ggplot(housing_2024_all, aes(x = Median_Sale_Price_per_k)) +
  geom_histogram(binwidth = 50, fill = "skyblue", color = "black") +
  scale_x_continuous(labels = scales::dollar_format(prefix = "$", suffix = "k")) +
  labs(
    title = "Distribution of Median Sale Prices (2024)",
    x = "Median Sale Price (in thousands)",
    y = "Count",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()
#needs a subtitle with commentary, just remembered all need a caption with the source named, and we can prob add other elements to this, because otherwise it seems to obvi to me
```


### boxplot of sale price by affordability tier


```{r boxplot_price_by_affordability}
ggplot(housing_2024, aes(x = Affordability, y = Median_Sale_Price_per_k, fill = Affordability)) +
  geom_boxplot() +
  labs(
    title = "Median Sale Price by Affordability Tier (2024)",
    x = "Affordability Tier",
    y = "Median Sale Price (in thousands)",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()
#no duh, there are more unpurchased expensive houses because people can't afford it 
#not sure how useful this is, but maybe as a starting baseline 
```


### scatterplot of months supply vs median price


```{r scatter_supply_vs_median_price total all}
ggplot(housing_2024_all_plot, aes(x = Months_Supply, y = Median_Sale_Price_per_k)) +
  geom_point(color="steelblue", alpha = 0.7) +
  # geom_smooth(method = "lm", se = FALSE, color = "black") +
  labs(
    title = "Months Supply of Housing vs Median Sale Price",
    subtitle= "A Scatterplot Reveals a Positive Correlation Between Months Supply\nof Housing and Median Sale Price",
    x = "Months of Supply",
    y = "Median Sale Price (in thousands)",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()

#next round, add line of best fit/ regression line
```


### correlation heatmap of numeric variables
```{r}
#correlation heatmap of numeric variables w/ ..._all df
housing_numeric_all <- housing_2024_all %>%
  select(where(is.numeric) & !all_of("Year")) %>%
  drop_na()

cor_matrix_all <- cor(housing_numeric_all)

corrplot(cor_matrix_all, method = "color", type = "upper", tl.cex = 0.8, addCoef.col = "black", number.cex=0.5)
#interesting to see positive and inverse relationships between variables 
#did not scan for no relationships
```
### both together in gray with compare in color with states labeled

```{r}
#both together in gray with compare in color with states labeled w/ ..._all df
ggplot() +
  geom_point(data = housing_2024_all, 
             aes(x = Months_Supply, y = Median_Sale_Price_per_k), 
             color = "gray70", alpha = 0.3, size = 1) +
  # geom_path(data = housing_compare %>% filter(StateGroup == "States with the Most Houses"),
  #           aes(x = Months_Supply, y = Median_Sale_Price_per_k, group = State, color = State),
  #           alpha = 0.8, size = 1) +
  geom_point(data = housing_compare_all %>% filter(StateGroup == "States with the Most Houses"),
             aes(x = Months_Supply, y = Median_Sale_Price_per_k, color = State),
             alpha = 0.5, size = 2) +
  # geom_path(data = housing_compare %>% filter(StateGroup == "States with the Fewest Houses"),
  #           aes(x = Months_Supply, y = Median_Sale_Price_per_k, group = State, color = State),
  #           alpha = 0.8, size = 1) +
  geom_point(data = housing_compare_all %>% filter(StateGroup == "States with the Fewest Houses"),
             aes(x = Months_Supply, y = Median_Sale_Price_per_k, color = State),
             alpha = 0.5, size = 2) +
  scale_color_manual(values = state_colors_all) +
  labs(
    title = "Housing Supply vs Median Price: All Counties with Highlights",
    subtitle = "Gray points: All counties | Blue shades: States with Most Houses | Red shades: States with Fewest Houses",
    x = "Months of Supply",
    y = "Median Sale Price (in thousands)",
    color = "State",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()
```


### new construction vs median sale price


```{r new_constr_vs_price}
housing_constr = housing_2024
housing_constr = housing_constr %>% 
  mutate(constr_bins = cut(New_Constr_by_share_of_sales_percent, breaks=10))

ggplot(housing_constr, aes(x = constr_bins, y = Median_Sale_Price_per_k,fill=constr_bins)) +
  geom_boxplot() +
  labs(
    title = "Median Sale Price by Percent New Construction (2024)",
    x = "New Construction by Share of Sales Percent",
    y = "Median Sale Price (in thousands)",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()

# Perhaps new construction indicates high demand, and as such, the more new construction, the higher the median sale price?
#I would like to know which states fall into these buckets. In which states are the top quarter and bottom quarter? BW
#I'm going to break this into smaller buckets and investigate.BW
```


```{r}
#new construction vs median sale price w/ ..._all df
housing_constr_all = housing_2024_all
housing_constr_all = housing_constr_all %>% 
  mutate(constr_bins = cut(New_Constr_by_share_of_sales_percent, breaks=10))

ggplot(housing_constr_all, aes(x = constr_bins, y = Median_Sale_Price_per_k, fill=constr_bins)) +
  geom_boxplot() +
  labs(
    title = "Median Sale Price by Percent New Construction (2024)",
    x = "New Construction by Share of Sales Percent",
    y = "Median Sale Price (in thousands)",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()

# Perhaps new construction indicates high demand, and as such, the more new construction, the higher the median sale price?
```


#### Limit to Entry-Level houses


```{r new_constr_vs_price_entrylevel}
housing_constr_tiers = housing_2024_tiers
housing_constr_tiers = housing_constr_tiers %>% 
  mutate(constr_bins = cut(New_Constr_by_share_of_sales_percent, breaks=10))

ggplot(filter(housing_constr,Affordability=="entrylevel"), aes(x = constr_bins, y = Median_Sale_Price_per_k,fill=constr_bins)) +
  geom_boxplot() +
  labs(
    title = "Median Sale Price by Percent New Construction (2024)",
    x = "New Construction by Share of Sales Percent",
    y = "Median Sale Price (in thousands)",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()

# Even more pronounced here
```


#### Limit to Moveup houses

```{r new_constr_vs_price_moveup}
ggplot(filter(housing_constr,Affordability=="moveup"), aes(x = constr_bins, y = Median_Sale_Price_per_k,fill=constr_bins)) +
  geom_boxplot() +
  labs(
    title = "Median Sale Price by Percent New Construction (2024)",
    x = "New Construction by Share of Sales Percent",
    y = "Median Sale Price (in thousands)",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()

# Even more pronounced here
```


###mapping US counties by median sale price


```{r}
##basemap

#reading in counties spatial file from tigris package
counties_2024 <- counties(year = 2013, 
                          cb = TRUE, 
                          class = "sf",
                          progress_bar = FALSE)

#excluding territories and shifting AK/HI
counties_2024 <- counties_2024 %>%
  filter(as.numeric(STATEFP) < 60) %>%
  shift_geometry()

#removing duplicate columns
counties_2024 <- counties_2024 %>%
  select(-NAME)

#creating basemap and checking
counties_2024_basemap <- ggplot() +
  geom_sf(data = counties_2024) +
  theme_void()

#counties_2024_basemap

##prepping and merging housing_2014_all w/ counties_2014

housing_2024_all <- housing_2024_all %>%
  mutate(price_bin = cut(Median_Sale_Price_per_k,
                         breaks = c(0, 150, 300, 500, 750, 1000, Inf),
                         labels = c("<150k", "150-300k", "300-500k", "500-750k", "750k-1M", ">1M")))

#creating merge df and prepping counties df
housing_merge <- housing_2024_all

counties_2024 <- counties_2024 %>%
  mutate(GEOID = as.numeric(GEOID))

#adding id variables to track observations
counties_2024$id1 <- 1
housing_merge$id2 <- 1

#merging
housing_counties_merge <- merge(x = counties_2024,
                                y = housing_merge,
                                by.x = "GEOID",
                                by.y = "FIPS_County_Code",
                                all = TRUE)

#converting NAs to zeros and finding problem observations
  #looks like it merged just fine
    #i lied, coded wrong and fixed, now i realize theres a  
    #lot of problem observations 
housing_counties_merge <- housing_counties_merge %>%
  mutate(id1 = ifelse(is.na(id1), 0, id1),
         id2 = ifelse(is.na(id2), 0, id2))

no_merge <- housing_counties_merge %>%
  filter(id1 + id2 != 2)

#unique(no_merge$GEOID)

#plotting and checking
housing_counties_plot <- ggplot() +
  geom_sf(data = housing_counties_merge,
          mapping = aes(fill = Median_Sale_Price_per_k),
          linetype = 0) +
  #scale_fill_brewer(palette = "GnBi") +
  theme(legend.position = "none") +
  theme_void()

#housing_counties_plot

#for fun: trying st_simplify to see if it looks better
housing_counties_merge_simple <- st_simplify(housing_counties_merge, dTolerance = 75)

housing_counties_plot2 <- ggplot() +
  geom_sf(data = housing_counties_merge_simple,
          mapping = aes(fill = price_bin),
          linetype = 0) +
  scale_fill_brewer(palette = "RdYlBu",
                    direction = -1,
                    name = "Median Sale Price",
                    na.value = "grey85") +
  labs(title = "Geographic Variation in U.S. Home Prices, 2024",
       subtitle = "County-level median sale price",
       caption = "Source: AEI Housing Center (2024)") +
  theme_minimal(base_size = 11) +
  theme(plot.title = element_text(face = "bold", 
                                  size = 16),
        plot.subtitle = element_text(size = 12, 
                                     margin = margin(b = 8)),
        plot.caption = element_text(color = "gray40", 
                                    margin = margin(t = 8)),
        legend.title = element_text(face = "bold"),
        legend.position = "right",
        legend.key.height = unit(0.6, "cm"),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(8, 12, 8, 12))
#+ theme_void()

housing_counties_plot2

####i could of course leave the color gradient and show the concentration or i could bin ranges of prices to different colors on the gradient scale. perhaps by affordability or something else that's useful? want to convene with team.
#BW: I think bins and/or a more drastic color scale could help readability. Like- dark purple, medium pink, orangey-yellow would be immediately visibly different
####i plan to add useful titles, labels, and commentary where necessary when i work on this next.
#BW: when the regional differences are more clear, we need to think about the story this map tells and how it fits into our overall narrative. 
```


```{r}
#hist of months supply

#hist plotting months supply with df ...top_states_all
ggplot(housing_compare_all, aes(x = reorder(State, Months_Supply, median), 
                         y = Months_Supply)) +
  geom_boxplot(fill = state_colors_all, alpha = 0.7) +
  coord_flip() +
  labs(
    title = "Distribution of Months Supply (2024)",
    x = "State",
    y = "Months Supply",
    caption = "SOURCE: American Enterprise Institute") +
  theme_minimal()

#needs a subtitle with commentary, just remembered all need a caption with the source named, and we can prob add other elements to this, because otherwise it seems to obvi to me




#z score
#confidence interval (on what tho, maybe median sale price and months supply)
#then add Zscore and CI onto scatterplot somehow?
```
